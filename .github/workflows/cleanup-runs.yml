name: Cleanup Workflow Runs

on:
  schedule:
    - cron: "0 3 * * 0"
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old runs
        env:
          RETAIN_PER_BRANCH: 20
        run: |
          set -euo pipefail

          # Requires GitHub CLI (`gh`) to be available in the runner.
          # RETAIN_PER_BRANCH controls how many recent runs to keep per branch.

          REPO="${GITHUB_REPOSITORY}"
          all_runs=$(gh api -H "Accept: application/vnd.github+json" \
            "/repos/${REPO}/actions/runs?per_page=100" --paginate)

          echo "$all_runs" \
            | jq -c '.workflow_runs[] | select(.head_branch == null)' \
            | while read -r run; do
                run_id=$(echo "$run" | jq -r '.id')
                echo "Deleting run $run_id (no branch)"
                gh api -X DELETE "/repos/${REPO}/actions/runs/${run_id}"
              done

          echo "$all_runs" \
            | jq -r '.workflow_runs[].head_branch' \
            | grep -v '^null$' \
            | sort -u \
            | while read -r branch; do
                branch_runs=$(gh api -H "Accept: application/vnd.github+json" \
                  "/repos/${REPO}/actions/runs?branch=${branch}&per_page=100" --paginate)

                echo "$branch_runs" \
                  | jq -r --argjson retain "$RETAIN_PER_BRANCH" \
                    '.workflow_runs
                    | sort_by(.updated_at)
                    | reverse
                    | .[$retain:]
                    | .[].id' \
                  | while read -r run_id; do
                      if [ -n "$run_id" ]; then
                        echo "Deleting run $run_id for branch $branch (exceeds retention)"
                        gh api -X DELETE "/repos/${REPO}/actions/runs/${run_id}"
                      fi
                    done
              done
