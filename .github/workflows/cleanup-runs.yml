name: Cleanup Workflow Runs

on:
  schedule:
    - cron: "0 3 * * 0"
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old runs
        env:
          RETAIN_PER_BRANCH: 20
        run: |
          set -euo pipefail

          # Requires GitHub CLI (`gh`) to be available in the runner.
          # RETAIN_PER_BRANCH controls how many recent runs to keep per branch.

          REPO="${GITHUB_REPOSITORY}"
          gh api -H "Accept: application/vnd.github+json" \
            "/repos/${REPO}/actions/runs" --paginate \
            | jq -r --argjson retain "$RETAIN_PER_BRANCH" '
                .workflow_runs as $runs
                | ($runs
                  | map(select(.head_branch == null))
                  | .[]
                  | {id, reason: "no branch"})
                ,
                ($runs
                  | sort_by(.head_branch)
                  | group_by(.head_branch)
                  | .[]
                  | select(.[0].head_branch != null)
                  | sort_by(.updated_at)
                  | if length > $retain then .[0:(length - $retain)] else [] end
                  | .[]
                  | {id, branch: .head_branch, reason: "exceeds retention"})
                | "\(.id)\t\(.branch // "")\t\(.reason)"
              ' \
            | while IFS=$'\t' read -r run_id branch reason; do
                if [ "$reason" = "no branch" ]; then
                  echo "Deleting run $run_id (no branch)"
                  gh api -X DELETE "/repos/${REPO}/actions/runs/${run_id}"
                  continue
                fi

                echo "Deleting run $run_id for branch $branch (exceeds retention)"
                gh api -X DELETE "/repos/${REPO}/actions/runs/${run_id}"
              done
